<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <title>Quick WASM Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .color-swatch { 
            display: inline-block; 
            width: 30px; 
            height: 30px; 
            margin: 2px; 
            border: 1px solid #ccc; 
            vertical-align: middle;
        }
        .input-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .input-section input {
            width: 60%;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-section button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-section button:hover {
            background-color: #0056b3;
        }
        #imagePreview {
            max-width: 300px;
            max-height: 200px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ WASM Library Quick Test</h1>
    
    <div class="input-section">
        <h3>üñºÔ∏è Test with Image URL</h3>
        <label for="imageUrl">Image URL:</label>
        <input type="url" id="imageUrl" placeholder="Enter image URL (e.g., https://picsum.photos/400/300)" />
        <label for="colorCount">Colors:</label>
        <input type="number" id="colorCount" min="1" max="20" value="5" placeholder="Colors" style="width: 80px;" />
        <button id="extractBtn">Extract Palette</button>
        <br>
        <img src="" alt="" id="imagePreview" style="display: none;" />
    </div>
    
    <div id="results"></div>

    <script type="module">
        import { PaletteExtractor, Color } from './pkg/image_color_palette_extractor.js';

        let extractor = null;

        async function initWasm() {
            if (!extractor) {
                extractor = new PaletteExtractor();
            }
        }

        // Function to test image from URL
        async function testImageFromUrl() {
            const urlInput = document.getElementById('imageUrl');
            const colorCountInput = document.getElementById('colorCount');
            const imagePreview = document.getElementById('imagePreview');

            const url = urlInput.value.trim();
            const colorCount = parseInt(colorCountInput.value) || 5;

            if (!url) {
                addResult('‚ùå Please enter a valid image URL', 'error');
                return;
            }

            try {
                await initWasm();
                addResult('üîÑ Loading image from URL...', 'success');

                // Create an image element and load from URL
                const img = new Image();
                img.crossOrigin = 'anonymous'; // Enable CORS for external images

                img.onload = function () {
                    try {
                        // Show preview
                        imagePreview.src = url;
                        imagePreview.style.display = 'block';

                        // Create canvas to get image data
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);

                        const imageData = ctx.getImageData(0, 0, img.width, img.height);
                        addResult(`‚úÖ Image loaded: ${img.width}x${img.height} pixels`, 'success');

                        // Extract palette
                        const palette = extractor.extract_palette_from_pixels(imageData.data, colorCount);
                        const colors = palette.colors();
                        const percentages = palette.percentages();

                        let colorDisplay = '';
                        colors.forEach((c, i) => {
                            colorDisplay += `<span class="color-swatch" style="background-color: ${c.to_hex()}" title="${c.to_hex()} - ${percentages[i].toFixed(1)}%"></span>`;
                        });

                        addResult(`üé® Palette extracted (${colorCount} colors): ${colorDisplay}`, 'success');

                        // Extract dominant color
                        const dominant = extractor.extract_dominant_color(imageData.data);
                        addResult(`üëë Dominant color: <span class="color-swatch" style="background-color: ${dominant.to_hex()}"></span> ${dominant.to_hex()}`, 'success');

                        // Show color details
                        colors.forEach((c, i) => {
                            addResult(`Color ${i + 1}: ${c.to_hex()} (${c.to_rgb_string()}) - ${percentages[i].toFixed(1)}%`, 'success');
                        });

                    } catch (error) {
                        addResult(`‚ùå Error processing image: ${error.message || error}`, 'error');
                        console.error(error);
                    }
                };

                img.onerror = function () {
                    console.error('Failed to load image from URL:', url);
                    // Try multiple CORS proxy fallbacks
                    tryWithCorsProxies(url);
                };

                function tryWithCorsProxies(originalUrl) {
                    const corsProxies = [
                        `https://cors-anywhere.herokuapp.com/${originalUrl}`,
                        `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`,
                        `https://corsproxy.io/?${encodeURIComponent(originalUrl)}`,
                        `https://cors.bridged.cc/${originalUrl}`
                    ];
                    
                    let proxyIndex = 0;
                    
                    function tryNextProxy() {
                        if (proxyIndex >= corsProxies.length) {
                            addResult('‚ùå Failed to load image from URL. This may be due to CORS restrictions.', 'error');
                            imagePreview.style.display = 'none';
                            return;
                        }
                        
                        const proxyUrl = corsProxies[proxyIndex];
                        addResult(`üîÑ Trying CORS proxy ${proxyIndex + 1}/${corsProxies.length}...`, 'success');
                        
                        const proxyImg = new Image();
                        proxyImg.crossOrigin = 'anonymous';
                        
                        proxyImg.onload = function() {
                            try {
                                // Show preview
                                imagePreview.src = originalUrl;
                                imagePreview.style.display = 'block';

                                // Create canvas to get image data
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                canvas.width = proxyImg.width;
                                canvas.height = proxyImg.height;
                                ctx.drawImage(proxyImg, 0, 0);

                                const imageData = ctx.getImageData(0, 0, proxyImg.width, proxyImg.height);
                                addResult(`‚úÖ Image loaded via proxy: ${proxyImg.width}x${proxyImg.height} pixels`, 'success');

                                // Extract palette
                                const palette = extractor.extract_palette_from_pixels(imageData.data, colorCount);
                                const colors = palette.colors();
                                const percentages = palette.percentages();

                                let colorDisplay = '';
                                colors.forEach((c, i) => {
                                    colorDisplay += `<span class="color-swatch" style="background-color: ${c.to_hex()}" title="${c.to_hex()} - ${percentages[i].toFixed(1)}%"></span>`;
                                });

                                addResult(`üé® Palette extracted (${colorCount} colors): ${colorDisplay}`, 'success');

                                // Extract dominant color
                                const dominant = extractor.extract_dominant_color(imageData.data);
                                addResult(`üëë Dominant color: <span class="color-swatch" style="background-color: ${dominant.to_hex()}"></span> ${dominant.to_hex()}`, 'success');

                                // Show color details
                                colors.forEach((c, i) => {
                                    addResult(`Color ${i + 1}: ${c.to_hex()} (${c.to_rgb_string()}) - ${percentages[i].toFixed(1)}%`, 'success');
                                });

                            } catch (error) {
                                addResult(`‚ùå Error processing image with proxy ${proxyIndex + 1}: ${error.message || error}`, 'error');
                                console.error(error);
                                proxyIndex++;
                                tryNextProxy();
                            }
                        };
                        
                        proxyImg.onerror = function() {
                            addResult(`‚ùå Proxy ${proxyIndex + 1} failed`, 'error');
                            proxyIndex++;
                            tryNextProxy();
                        };
                        
                        proxyImg.src = proxyUrl;
                    }
                    
                    tryNextProxy();
                }

                img.src = url;

            } catch (error) {
                addResult(`‚ùå Error: ${error.message || error}`, 'error');
                console.error(error);
            }
        }

        // bind testImageFromUrl to extractBtn
        const submitBtn = document.getElementById('extractBtn');
        if(submitBtn)
            submitBtn.addEventListener('click', testImageFromUrl);

        async function runTests() {
            try {
                // Initialize WASM
                await initWasm();
                addResult('‚úÖ WASM module loaded successfully', 'success');
                
                // Test 1: Create an extractor
                addResult('‚úÖ PaletteExtractor created', 'success');
                
                // Test 2: Create color
                const color = new Color(255, 128, 64);
                addResult(`‚úÖ Color created: ${color.to_hex()} - ${color.to_rgb_string()}`, 'success');
                
                // Test 3: Extract palette from simple data
                const pixels = new Uint8Array([
                    255, 0, 0, 255,   // Red
                    255, 0, 0, 255,   // Red
                    0, 0, 255, 255,   // Blue
                    0, 0, 255, 255,   // Blue
                    0, 255, 0, 255,   // Green
                    0, 255, 0, 255,   // Green
                ]);
                
                const palette = extractor.extract_palette_from_pixels(pixels, 3);
                const colors = palette.colors;
                const percentages = palette.percentages;
                
                let colorDisplay = '';
                colors.forEach((c, i) => {
                    colorDisplay += `<span class="color-swatch" style="background-color: ${c.to_hex()}" title="${c.to_hex()} - ${percentages[i].toFixed(1)}%"></span>`;
                });
                
                addResult(`‚úÖ Palette extracted: ${colors.length} colors ${colorDisplay}`, 'success');
                
                // Test 4: Extract dominant color
                const dominant = extractor.extract_dominant_color(pixels);
                addResult(`‚úÖ Dominant color: <span class="color-swatch" style="background-color: ${dominant.to_hex()}"></span> ${dominant.to_hex()}`, 'success');
                
                addResult('üéâ All basic tests passed!', 'success');
                addResult('üí° Try entering an image URL above to test with real images!', 'success');
                
            } catch (error) {
                addResult(`‚ùå Error: ${error.message || error}`, 'error');
                console.error(error);
            }
        }
        
        function addResult(message, type) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        // Auto-run basic tests on the page load
        runTests();
    </script>
</body>
</html>
